<!doctype html><html class=no-js lang=en-us xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Running docker on 32-bit hosts"><meta name=author content><meta name=keyword content><link rel="shortcut icon" href=/favicon.ico><title>Running docker on 32-bit hosts &#183; the daily meh</title><link rel=stylesheet href=https://nagimov.me/css/theme/flatly.css><link rel=stylesheet href=https://nagimov.me/css/font-awesome.min.css><link rel=stylesheet href=https://nagimov.me/css/style.css><script src=https://nagimov.me/js/jquery.min-2.1.4.js></script><script src=https://nagimov.me/js/bootstrap.min-3.3.5.js></script><script>var remark_config={site_id:'nagimov_me',theme:'light',};(function(){var d=document,s=d.createElement('script');s.src='https://remark.ngm.me/web/embed.js';(d.head||d.body).appendChild(s);})();</script><script type=text/javascript>var owa_baseUrl='https://owa.ngm.me/';var owa_cmds=owa_cmds||[];owa_cmds.push(['setSiteId','59705c41feb07994848a84ac449fb28d']);owa_cmds.push(['trackPageView']);owa_cmds.push(['trackClicks']);(function(){var _owa=document.createElement('script');_owa.type='text/javascript';_owa.async=true;owa_baseUrl=('https:'==document.location.protocol?window.owa_baseSecUrl||owa_baseUrl.replace(/http:/,'https:'):owa_baseUrl);_owa.src=owa_baseUrl+'modules/base/js/owa.tracker-combined-min.js';var _owa_s=document.getElementsByTagName('script')[0];_owa_s.parentNode.insertBefore(_owa,_owa_s);}());</script><link href rel=alternate type=application/rss+xml title="the daily meh"></head><body lang=en><div class=container><div class=row><div class="navbar navbar-default" role=navigation><div class=navbar-header><a class=navbar-brand href=https://nagimov.me>the daily meh</a></div><div class="navbar-collapse collapse navbar-responsive-collapse"><ul class="nav navbar-nav navbar-right"><li><a href=https://nagimov.me>Home</a></li><li><a href=https://nagimov.me/post/>Posts</a></li><li><a href=/about/>About</a></li></ul></div></div></div></div><div class=container><div class=row><div class="col-md-offset-1 col-md-10" style=display:flex;justify-content:space-between><div><h3>Running docker on 32-bit hosts</h3></div><div>&nbsp;&nbsp;&nbsp;&nbsp;</div><div style=margin-bottom:10.5px;margin-top:21px><span class="label label-primary">2019-02-03</span></div></div></div><div class=row><div class="col-md-offset-1 col-md-10"><p>Docker is known to not to support 32-bit hosts. As per their <a href=https://docs.docker.com/install/linux/docker-ce/debian>debian installation instruction</a>: <code>Docker CE is supported on x86_64 (or amd64), armhf, and arm64 architectures.</code> And that is plain wrong.</p><p>A tiny bit of extra support from docker-the-company would extend its use to older hardware, but (apparently) this is not a priority. &ldquo;Let&rsquo;s bring docker on 32-bit&rdquo; <a href=https://github.com/moby/moby/issues/136>issue</a> was closed and locked in 2014, and nothing has changed since then.</p><p>Nothing fundamentally prevents docker (including latest version of docker CE) from being run on 32-bit platforms (except the lack of support from docker-the-company, of course). I&rsquo;m currently running (a bit outdated) version <code>18.03.0-ce</code> of docker on 15 years old <a href="https://www-01.ibm.com/common/ssi/cgi-bin/ssialias?infotype=AN&subtype=CA&htmlfid=897/ENUS104-011">IBM xSeries 335 server</a> with whopping 2.8GHz Intel Xeon and 4GB of DDR RAM (just for the sake of it, of course). That&rsquo;s enough to run half a dozen containers (nginx proxy with simple API end points) and a bunch of scripts poking at various sensors via <a href=https://labjack.com/>LabJack IO board</a>).</p><p><img src=/images/ibm-xseries-335.jpg#center alt=width500px></p><p>The server only supports IDE drives and I had to use a floppy diskette to sideload firmware for the network card (USB port wasn&rsquo;t recognized by debian installer). This particular server been in 24/7 operation since its birth, with a brief interruption for two years in 2013-2014, when its ownership has changed (yeah, I picked it from the scrap yard). I have two complete replacement spares and I don&rsquo;t care about electricity bill, so it&rsquo;s good enough piece of hardware for some lightweight business. Also check out its early 2000&rsquo;s boot animation (how can one simply retire such a fine piece of equipment?!):</p><p><img src=/images/ibm-xseries-335-boot-diskette.gif#center alt=width300px></p><p>There are obviously no official docker builds for 32-bit platforms, but <a href=https://github.com/mforkel/docker-ce-i386>this fork</a> adds support for building docker CE for i386. It is slightly outdated (<code>18.03.0-ce</code> as of February 2019), albeit I can&rsquo;t remember any sweet features released since then anyways (yet).</p><p>The build scripts are x64 platform oriented, so if you can build docker on 64-bit platform first, the recipe should work as-is.</p><p>I decided to challenge myself and try to run the whole installation using only 32-bit server, so there were few changes required to complete the build.</p><h4 id=prerequisites>Prerequisites</h4><ul><li>debian 9.5.0 32-bit installed</li><li>apt repositories configured to use internet connection</li><li><code>sudo</code>, <code>git</code> and <code>build-essential</code> installed in addition to bare debian image</li></ul><h4 id=installing-docker-io>Installing <code>docker-io</code></h4><p>The above mentioned build scripts for docker make use of existing docker installation. So if we want to build docker for 32-bit platform, we have to have docker installed (<code>WinRAR.rar</code>, anyone?)</p><p>As hopeless as it sounds, there is a way out. <code>Docker.io</code> package from <code>jessie-backports</code> is actually <em>runnable</em> on 32-bit, even though there is a big red flag in the <a href=https://packages.debian.org/jessie-backports/docker.io>description</a>: <code>Using docker.io on non-amd64 hosts is not supported at this time. Please be careful when using it on anything besides amd64.</code> We are not going to use <code>docker.io</code> in production, and it works fine as a simple build environment.</p><p>Install the package:</p><ul><li>add <code>deb https://deb.debian.org/debian jessie-backports main</code> to your apt sources in <code>/etc/apt/sources.list</code></li><li>update package index: <code>sudo apt-get update</code></li><li>install the package: <code>sudo apt-get -t jessie-backports install docker.io</code></li><li>check the version of docker binary: <code>docker -v</code> (outputs <code>Docker version 1.6.2, build 7c8fca2</code>)</li></ul><h4 id=building-docker-from-sources>Building docker from sources</h4><p>Let&rsquo;s then get to it and build (relatively) fresh docker from <a href=https://github.com/mforkel/docker-ce-i386>this magic repo</a>.</p><p>Clone the repo:</p><ul><li><code>cd /tmp</code></li><li><code>git clone https://github.com/mforkel/docker-ce-i386</code></li><li><code>cd docker-ce-i386</code></li></ul><p>Depending from the current state of this github repository, you might have to switch to the proper branch, e.g. <code>git checkout 18.03-i386</code>, depending from which versions are available. I&rsquo;ll be fixing this build to the latest commit available as of February, 2019, so it&rsquo;s reproducible:</p><ul><li><code>git checkout c68b084</code></li></ul><p>Again, the build script assumes that you have relatively fresh version of docker installed already. Our <code>docker.io</code> is from 2015, and it doesn&rsquo;t support <code>ARG</code> parameter of Dockerfiles. We need to get rid of it:</p><ul><li><code>sed -i "s/ARG APT_MIRROR=deb.debian.org/# ARG APT_MIRROR=deb.debian.org/" ./components/engine/contrib/builder/deb/i386/debian-stretch/Dockerfile</code></li><li><code>sed -i "s/\$APT_MIRROR/deb.debian.org/" ./components/engine/contrib/builder/deb/i386/debian-stretch/Dockerfile</code></li><li><code>sed -i "s/ARG APT_MIRROR=deb.debian.org/# ARG APT_MIRROR=deb.debian.org/" ./components/packaging/deb/debian-stretch/Dockerfile.i386</code></li><li><code>sed -i "s/\$APT_MIRROR/deb.debian.org/g" ./components/packaging/deb/debian-stretch/Dockerfile.i386</code></li></ul><p>The build script also makes use of the official <code>alpine</code> image from dockerhub, that is 64-bit. It has to be replaced with <code>i386/alpine</code> image:</p><ul><li><code>sed -i "s/alpine/i386\/alpine/" ./components/packaging/deb/Makefile</code></li></ul><p>Now it&rsquo;s finally time to run the build (be patient):</p><ul><li><code>sudo ARCH=i386 DOCKER_BUILD_PKGS=debian-stretch make deb</code></li></ul><p>Make sure that newly built <code>*.deb</code> package is there:</p><ul><li><code>ls ./components/packaging/deb/debbuild/debian-stretch/</code></li></ul><p>Remove old docker installation:</p><ul><li><code>sudo apt-get remove docker.io</code></li></ul><p>Install newly built <code>*.deb</code> package:</p><ul><li><code>sudo dpkg -i ./components/packaging/deb/debbuild/debian-stretch/docker-ce_18.03.0~ce-0~debian_i386.deb</code></li><li><code>sudo apt-get install -f</code></li></ul><p>And we&rsquo;re done:</p><ul><li><code>docker -v</code> (outputs <code>Docker version 18.03.0-ce, build c68b084381</code>)</li><li><code>sudo docker run hello-world</code></li></ul><h4 id=getting-32-bit-docker-compose>Getting 32-bit docker-compose</h4><p>This one is much easier, since i386 package of <code>docker-compose</code> is available from <a href=https://launchpad.net/ubuntu/xenial/i386/docker-compose/1.8.0-2~16.04.1>this</a> Ubuntu Xenial repository, so installation is as simple as:</p><ul><li><code>cd /tmp</code></li><li><code>wget https://launchpadlibrarian.net/314562376/docker-compose_1.8.0-2~16.04.1_all.deb</code></li><li><code>sudo dpkg -i docker-compose_1.8.0-2~16.04.1_all.deb</code></li><li><code>sudo apt-get install -f</code></li><li><code>docker-compose --version</code> (outputs <code>docker-compose version 1.8.0, build unknown</code>)</li></ul><h4 id=living-with-docker-on-32-bit>Living with docker on 32-bit</h4><p>Bear in mind, this is not the end of the journey. Most of the available images are built using 64-bit binaries (see the above mentioned official <code>alpine</code> image), so there will be issues. E.g., the very popular <a href=https://github.com/jwilder/nginx-proxy>nginx-proxy</a> uses 64-bit builds of both <a href=https://github.com/jwilder/docker-gen>docker-gen</a> and <a href=https://github.com/jwilder/forego>forego</a>, and based on official <code>nginx:1.11.10</code> image (based on official <code>debian:jessie</code> x64), so the corresponding changes are required:</p><ul><li>i386 builds of docker-gen are available from <a href=https://github.com/jwilder/docker-gen/releases>releases</a></li><li>i386 build of forego can be found <a href=https://dl.equinox.io/ddollar/forego/stable/archive>here</a></li><li>bump nginx version to <code>nginx:1.14</code> - it&rsquo;s built from <code>debian:stretch-slim</code> x32</li></ul><p>Another example - must-have sibling of nginx-proxy, <a href=https://github.com/JrCs/docker-letsencrypt-nginx-proxy-companion>letsencrypt-nginx-proxy-companion</a>, based on official <code>alpine</code> image x64 and uses <a href=https://github.com/jwilder/docker-gen>docker-gen</a> as well, therefore:</p><ul><li>replace <code>alpine</code> with <code>i386/alpine</code></li><li>replace <code>docker-gen</code> with i386 build</li></ul><p>&mldr;and so on. Some images of course are just not worth porting back to 32-bit world, so usage of docker on 32-bit platforms is limited by simple images, but that&rsquo;s 90% of all my use-cases anyways :)</p><hr></div></div><div class=row><div class="col-md-offset-1 col-md-10" style=display:flex;justify-content:space-between><div>Tagged
#<a href=/tags/docker>docker</a>
,
#<a href=/tags/docker-compose>docker-compose</a>
,
#<a href=/tags/nginx-proxy>nginx-proxy</a>
,
#<a href=/tags/letsencrypt>letsencrypt</a>
,
#<a href=/tags/32-bit>32-bit</a>
,
#<a href=/tags/64-bit>64-bit</a>
,
#<a href=/tags/x86>x86</a>
,
#<a href=/tags/x86_64>x86_64</a>
,
#<a href=/tags/i386>i386</a>
,
#<a href=/tags/i686>i686</a>
,
#<a href=/tags/amd64>amd64</a>
,
#<a href=/tags/alpine>alpine</a>
,
#<a href=/tags/debian>Debian</a>
,
#<a href=/tags/jessie>Jessie</a>
,
#<a href=/tags/stretch>Stretch</a>
,
#<a href=/tags/ubuntu>Ubuntu</a>
,
#<a href=/tags/xenial>Xenial</a></div><div><span class="label label-primary">2019-02-03</span></div></div></div><div class=row><div class=col-md-12><hr></div></div><div class=row><div class="col-md-offset-1 col-md-10"><div id=remark42></div></div></div></div><div class=container><div class="row col-md-12"><footer><div class=pull-left><p>&copy; ~ Powered By <a href=http://hugo.spf13.com>Hugo</a> - version: 0.68.3 ~ <a href=https://creativecommons.org/licenses/by/4.0/>License: CC BY 4.0</a></p></div><div class=pull-right><a href=https://github.com/nagimov target=_blank><i class="fa fa-github-square fa-2x"></i></a></div></footer></div></div></body></html>