<!doctype html><html class=no-js lang=en-us xmlns=http://www.w3.org/1999/xhtml xml:lang=en lang=en-us><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="The Horror of PLC Programming"><meta name=author content><meta name=keyword content><link rel="shortcut icon" href=/favicon.ico><title>The Horror of PLC Programming &middot; the daily meh</title><link rel=stylesheet href=https://nagimov.me/css/theme/flatly.css><link rel=stylesheet href=https://nagimov.me/css/font-awesome.min.css><link rel=stylesheet href=https://nagimov.me/css/style.css><script src=https://nagimov.me/js/jquery.min-2.1.4.js></script><script src=https://nagimov.me/js/bootstrap.min-3.3.5.js></script><script>var remark_config={site_id:'nagimov_me',theme:'light',};(function(){var d=document,s=d.createElement('script');s.src='https://remark.ngm.me/web/embed.js';(d.head||d.body).appendChild(s);})();</script><script type=text/javascript>var owa_baseUrl='https://owa.ngm.me/';var owa_cmds=owa_cmds||[];owa_cmds.push(['setSiteId','59705c41feb07994848a84ac449fb28d']);owa_cmds.push(['trackPageView']);owa_cmds.push(['trackClicks']);(function(){var _owa=document.createElement('script');_owa.type='text/javascript';_owa.async=true;owa_baseUrl=('https:'==document.location.protocol?window.owa_baseSecUrl||owa_baseUrl.replace(/http:/,'https:'):owa_baseUrl);_owa.src=owa_baseUrl+'modules/base/js/owa.tracker-combined-min.js';var _owa_s=document.getElementsByTagName('script')[0];_owa_s.parentNode.insertBefore(_owa,_owa_s);}());</script><link href rel=alternate type=application/rss+xml title="the daily meh"></head><body lang=en><div class=container><div class=row><div class="navbar navbar-default" role=navigation><div class=navbar-header><a class=navbar-brand href=https://nagimov.me>the daily meh</a></div><div class="navbar-collapse collapse navbar-responsive-collapse"><ul class="nav navbar-nav navbar-right"><li><a href=https://nagimov.me>Home</a></li><li><a href=https://nagimov.me/post/>Posts</a></li><li><a href=/about/>About</a></li></ul></div></div></div></div><div class=container><div class=row><div class="col-md-offset-1 col-md-10"><small><span class="label label-primary">2019-10-03</span></small><h3>The Horror of PLC Programming</h3></div></div><div class=row><div class="col-md-offset-1 col-md-10"><p>Consider this simple code snippet&hellip;</p><pre><code>10  VALVE1_POS = S405_VH(1400)
20  VALVE2_POS = 80.0
30  IF VALVE1_POS &gt; 50.0 THEN VALVE3_POS = 99.5 ELSE VALVE3_POS = 0.5
</code></pre><p>&hellip;and let me follow your observations:</p><ul><li>you notice a weird line enumeration, just like in good old BASIC</li><li>you see three variables, <code>VALVE1_POS</code>, <code>VALVE2_POS</code> and <code>VALVE3_POS</code></li><li>you find <code>S405_VH(1400)</code> most likely to be a function call retrieving a position of the valve 1</li><li>position of the valve 2 is set to <code>80.0</code></li><li>following the last if-then-else statement, you realize that the valve 3 position is defined based on the valve 1 position</li></ul><p>Assuming this code compiles and runs correctly, can you think of a bug/feature that would cause all three variables to contain value <code>99.5</code>?</p><p>Here&rsquo;s another two-liner:</p><pre><code>10  VALVE1_STEP = 10.0
20  VALVE1_END = 90.0
</code></pre><p>Considering that the first example compiles to a valid program, can you think of a way to make the second one fail?</p><p>If you know the answers, then it is likely a good idea to stop reading now. No need to feed your professional anxieties. The rest are invited to follow through and discover the Horror of PLC Programming.</p><h3 id=why-so-basic>Why so BASIC?</h3><p>The code you see is indeed written in a limited and slightly deformed subset of BASIC. You may or may not find the lack of <code>LET</code>&rsquo;s to be awkward, but otherwise these snippets are plain and simple BASIC. There are no arrays with their <code>DIM</code>&rsquo;s and <code>REDIM</code>&rsquo;s to screw things up or <a href=https://stackoverflow.com/questions/18135971/quick-basic-colon-line-separator>colon controversies</a>. It&rsquo;s as basic as BASIC gets (sorry).</p><p>&ldquo;What a weird language choice for controlling valves!&rdquo; you say. &ldquo;What on flat-earth does this have to deal with 2019?&rdquo; you ask. Keep on reading.</p><p>PLCs are made to be robust and more often than not programmed using <a href=https://en.wikipedia.org/wiki/Ladder_logic>ladder logic</a>. PLC programs are not meant to be easy to write, but are easy to debug. You&rsquo;ll never find tail-recursion or polymorphism capabilities in PLC languages. There is no unit-testing, you&rsquo;ll test it in the field, attached to a big, heavy, piece of industrial machinery. Many of PLCs lack the most basic concepts like <em>variables</em>. Ladder logic is never mentioned at hackathons, your local meetups, or <a href="https://hn.algolia.com/?query=%22ladder%20logic%22">praised on hacker news</a>.</p><p><img src=/images/ladder-logic-hacker-news.png#center alt=width500px></p><p><a href=https://en.wikipedia.org/wiki/Programmable_logic_controller#Invention_and_early_development>As a natural evolution of electromechanical relay control systems</a>, ladder logic programming follows similar rules. Here&rsquo;s how a simple PLC program controlling AC unit might look like:</p><pre><code>1. ----[ ]---------+----[ ]-----+----( )
     Switch        |   HiTemp   |    A/C
                   |            |
                   +----[ ]-----+
                       Humid
2. ----[ ]----[\]--------------------( )
       A/C    Heat                 Cooling
</code></pre><p>Inputs &ldquo;relays&rdquo; are shown as <code>--[ ]--</code>, outputs are <code>--( )--</code>. When enough inputs are activated to create a &ldquo;current path&rdquo; to the output, it becomes &ldquo;energized&rdquo;. This worked well for early systems that were designed to replace relay boxes. Spoiled engineers however demanded fancier features, such as integer arithmetic, floating-point operations and even string manipulations. Following the lead of a semiconductor industry, PLC manufacturers complemented their systems with coprocessors for floating-point math and whatnot. Unfortunately, many of them haven&rsquo;t got further, albeit some systems nowadays support <a href=https://en.wikipedia.org/wiki/Structured_text>structured text</a> or even subsets of C/C++.</p><p>Back to 2019, a current generation of mid-level PLCs from a well known North American manufacturer requires a coprocessor to communicate with serial interfaces. This coprocessor is fancy enough to support floating point math and string manipulations and, you guessed it, is programmed in BASIC. Our happy PLC programmer is eager to use it to its full potential, multiply floats, truncate string and sometimes go crazy extracting square roots.</p><p>So let&rsquo;s get back to our first example:</p><pre><code>10  VALVE1_POS = S405_VH(1400)
20  VALVE2_POS = 80.0
30  IF VALVE1_POS &gt; 50.0 THEN VALVE3_POS = 99.5 ELSE VALVE3_POS = 0.5
</code></pre><h3 id=the-call-of-mysterious-s405-vh>The call of mysterious <code>S405_VH</code></h3><p>I know what you&rsquo;re thinking. The mysterious function that appears in the first example has some magical powers and is going to change the global state, hang the execution, or throw a weird uncatchable exception. This is not the case.</p><p><code>S405_VH(1400)</code> simply reads an octal word from specified memory address <code>V1400</code> in HEX format, hence <code>_VH</code>. What is an octal word, you ask? Well, it&rsquo;s just two 8-bit memory chunks stitched together, aka 16-bit. No, you can&rsquo;t call it a &ldquo;byte&rdquo;. It&rsquo;s an octal.</p><p>Why memory is addressed in such a weird way, <code>V1400</code>? There are two parts: <code>V</code> indicates a type of memory range. Along with <code>X</code>, <code>Y</code>, <code>C</code>, <code>T</code>, <code>CT</code>, <code>S</code>, <code>SP</code>, <code>GX</code> and <code>GY</code>, it partitions the PLC memory into various &ldquo;types&rdquo;. Some types are inputs, some are outputs, some store timers and counters, some store system configuration parameters. They can store octal words (16&nbsp;bit), single octals (8&nbsp;bit), or deal with individual bits directly.</p><p>The second part, <code>1400</code>, is the address of a memory location within the <code>V</code>&nbsp;memory type range. Since <code>1400</code> is an octal number, you would write it as <code>01400</code> in C, or <code>0o1400</code> in Python, but it&rsquo;s just the semantics of this particular PLC. Everything is an octal. This particular value, <code>0o1400</code> is the beginning of a specialized sub-range of the <code>V</code>&nbsp;memory type that spans from <code>0o1400</code> to <code>0o7377</code>, it is a so called &ldquo;User Data Types&rdquo; range. <code>V</code>&nbsp;memory ranges start at <code>0o700</code>, not <code>0o0</code> (remember typing <code>org 0x100</code> in x86 assembly, like, 30 years ago?). There are no variables, only an &ldquo;accumulator&rdquo;. Data management hasn&rsquo;t improved much since <code>mov ax, dx</code>. The point being that <strong>BASIC is a step ahead</strong> from native PLC code.</p><p>(You remember I said that everything is an octal? I lied. When you deal with data, then everything is HEX. Unless it&rsquo;s <a href=https://en.wikipedia.org/wiki/Binary-coded_decimal>binary-coded decimal (BCD)</a>, sometimes. If that&rsquo;s the case, it is programmer&rsquo;s responsibility to ensure that BCD-HEX conversions are handled properly, compile time checks don&rsquo;t catch that.)</p><h3 id=what-s-wrong-with-the-valves>What&rsquo;s wrong with the valves</h3><p>But I digress. We are trying to understand the first line of the first example, <code>VALVE1_POS = S405_VH(1400)</code>. &ldquo;I know!&rdquo; you say. &ldquo;It returns HEX instead of BCD! Or BCD instead of HEX! Or an integer instead of a float! That&rsquo;s where the bug is!&rdquo; But that would be too easy. So let&rsquo;s assume that <code>S405_VH(1400)</code> returns exactly what we expect and the variable <code>VALVE1_POS</code> now contains a legitimate value. And yet, after all three lines are executed, <code>VALVE1_POS</code>, <code>VALVE2_POS</code> and <code>VALVE3_POS</code> all contain value <code>99.5</code>. <strong>In fact they are all the same variable!</strong></p><p>Here&rsquo;s how this particular implementation of BASIC identifies variables by their names:</p><ul><li>get the first character of the variable name (A);</li><li>get the last character of the variable name (B);</li><li>get the length of the variable name (N);</li><li><strong>unique combination of A, B and N defines a variable</strong>, so <code>VALVE1_POS</code>, <code>VALVE2_POS</code> and <code>VALVE3_POS</code> are interpreted as identical names.</li></ul><p>Imagine the world where:</p><ul><li><code>TEMP1_C</code> and <code>TEMP2_C</code> are identical variables;</li><li><code>TIMER_RST_1</code> and <code>TIMER_ACC_1</code> are identical variables;</li><li><code>PRESSURE_GAGE</code>, <code>PRESSURE_TUBE</code> and <code>PRESSURE_PIPE</code> are all the same thing.</li></ul><p>Happy debugging.</p><h3 id=two-bugs-in-two-lines>Two bugs in two lines</h3><pre><code>10  VALVE1_STEP = 10.0
20  VALVE1_END = 90.0
</code></pre><p>This example is similarly annoying. In this particular BASIC world, variables cannot contain any keywords as a part of their names.</p><p><code>STEP</code> is a keyword. <code>END</code> is a keyword. <code>VALVE1_STEP</code> and <code>VALVE1_END</code> aren&rsquo;t valid variable names.</p><h3 id=docu-mentation>Docu&hellip; mentation?</h3><p>The fun way of discovering these &ldquo;features&rdquo; is of course through endless debugging (there is no actual debugger, you just print your variables to a serial port and catch them at the other end). Okay, let&rsquo;s assume you&rsquo;re keen to RTFM and download manuals from manufacturer&rsquo;s web-site. Unfortunately, they don&rsquo;t contain language specifications. You&rsquo;re not giving up and going through manuals for similar and discontinued modules. One of them describes this behavior as a &ldquo;helpful hint&rdquo; [sic] at the end of a code sample, in the &ldquo;TRANSFER INSTRUCTION&rdquo; chapter of the manual:</p><p><em>Helpful Hint: The variables LSB10 and LSB20, CODE15 and CODE25 or REG400 and REG410 will return the same value due to the way that BASIC stores variables. To avoid this problem, use dimensioned variables such as CODE(index) or REG(index).</em></p><p>No wonder you missed that. So you keep debugging. Your programming tool doesn&rsquo;t show any useful messages so you give up trying to google the problem. Days go by, and you make no progress. Desperate, you are seeking for advice. You are knocking at the door of &ldquo;Bob the PLC guy&rdquo; who is retiring in two days. You&rsquo;re hiding your tears and trying to stay calm. He looks at your code and smiles, pulls up an old IBM Thinkpad with Windows&nbsp;2000 and launches a weird looking version of the programming tool. He then presses <code>F1</code> and Microsoft Windows Help shows up. He types &ldquo;variables&rdquo; in the search bar and finds the page he needs. You look at the page, and you look at the guy. You&rsquo;re angry and happy at the same time. You copy the help file and thank Bob. You leave early that day and head to your favorite bar to have a little celebration. You are now a &ldquo;Level 2 PLC guy&rdquo;.</p><hr><h4 id=all-characters-and-other-entities-appearing-in-this-story-are-fictitious-any-resemblance-to-real-persons-dead-or-alive-or-other-real-life-entities-past-or-present-is-purely-coincidental><em>All characters and other entities appearing in this story are fictitious. Any resemblance to real persons, dead or alive, or other real-life entities, past or present, is purely coincidental.</em></h4></div></div><div class=row><div class="col-md-offset-1 col-md-10"><hr>Tagged
#<a href=/tags/plc>PLC</a>
,
#<a href=/tags/ics>ICS</a>
,
#<a href=/tags/control-system>control system</a>
,
#<a href=/tags/ladder-logic>ladder logic</a>
,
#<a href=/tags/basic>BASIC</a>
,
#<a href=/tags/horror>horror</a></div></div><div class=row><div class=col-md-12><hr></div></div><div class=row><div class="col-md-offset-1 col-md-10"><div id=remark42></div></div></div></div><div class=container><div class="row col-md-12"><footer><div class=pull-left><p>&copy; ~ Powered By <a href=http://hugo.spf13.com>Hugo</a> - version: 0.52 ~ <a href=https://creativecommons.org/licenses/by/4.0/>License: CC BY 4.0</a></p></div><div class=pull-right><a href=https://github.com/nagimov target=_blank><i class="fa fa-github-square fa-2x"></i></a></div></footer></div></div></body></html>